<!DOCTYPE html>
<html lang="cs">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Wishlist ‚Äî Nov√Ω projekt</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      :root {
        --accent: #c0235a;
        --muted: #6b7280;
      }
      body {
        font-family: Inter, system-ui, Arial, Helvetica, sans-serif;
        margin: 0;
        background: #fffafc;
        color: #111;
      }
      .wrap {
        max-width: 880px;
        margin: 2.5rem auto;
        padding: 1.25rem;
      }
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 1rem;
      }
      .card {
        background: #fff;
        padding: 1rem;
        border-radius: 10px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.04);
      }
      .meta {
        font-size: 0.95rem;
        color: var(--muted);
      }
      .btn {
        background: var(--accent);
        color: #fff;
        padding: 0.45rem 0.7rem;
        border-radius: 8px;
        border: none;
        cursor: pointer;
      }
      .btn.ghost {
        background: #fff;
        color: var(--accent);
        border: 1px solid rgba(0, 0, 0, 0.06);
      }
      .reservations {
        margin-top: 0.75rem;
        font-size: 0.9rem;
      }
      .small {
        font-size: 0.9rem;
        color: var(--muted);
      }
      .top-actions {
        margin-left: auto;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <h1 style="display: flex; align-items: center; gap: 0.7em">
          <span style="font-size: 2.1em; line-height: 1">üéÇ</span>
          M≈Øj narozeninov√Ω wishlist
        </h1>
        <div class="top-actions">
          <button id="seed" class="btn ghost" disabled>
            Klikni na tlaƒç√≠tko ‚ÄûChci koupit‚Äú a zadej sv√© jm√©no ‚Äî polo≈æka se t√≠m
            rezervuje a tvoje jm√©no se zobraz√≠ v seznamu rezervac√≠. Pokud chce≈°
            rezervaci zru≈°it, pou≈æij u dan√© rezervace tlaƒç√≠tko ‚ÄûZru≈°it‚Äú.
          </button>
        </div>
      </header>

      <div id="status" class="small"></div>

      <section class="items" id="items"></section>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
    <script>
      // KONFIGURACE: nahraƒète hodnotami z va≈°eho Supabase projektu
      // Note: do NOT paste any service_role (secret) key here. Use the ANON public key.
      const SUPABASE_URL = 'https://uddiuupxfyxmzkmdpauj.supabase.co';
      const SUPABASE_KEY = 'sb_publishable_VboYpoO_EW0InxTL6pRSiA_lxHLVW-p';

      const { createClient } = supabase;
      const client = createClient(SUPABASE_URL, SUPABASE_KEY);

      const statusEl = document.getElementById('status');
      const itemsEl = document.getElementById('items');
      const seedBtn = document.getElementById('seed');

      async function loadItems() {
        statusEl.textContent = 'Naƒç√≠t√°m polo≈æky‚Ä¶';
        const { data: items, error } = await client
          .from('items')
          .select('*, reservations(id,name,qty,status)')
          .order('id', { ascending: true });
        if (error) {
          statusEl.textContent = 'Chyba p≈ôi naƒç√≠t√°n√≠: ' + error.message;
          return;
        }
        renderItems(items || []);
        statusEl.textContent = '';
      }

      function renderItems(items) {
        itemsEl.innerHTML = '';
        if (items.length === 0) {
          itemsEl.innerHTML =
            '<div class="small">≈Ω√°dn√© polo≈æky. P≈ôidej uk√°zkov√© polo≈æky nebo vlo≈æ sv√© do DB.</div>';
          return;
        }
        items.forEach((item) => {
          const reserved = (item.reservations || [])
            .filter((r) => r.status === 'reserved')
            .reduce((s, r) => s + r.qty, 0);
          const avail = Math.max(0, (item.quantity || 1) - reserved);
          const div = document.createElement('div');
          div.className = 'card';
          div.innerHTML = `
          <strong>${escapeHtml(item.title)}</strong>
          <div class="meta">Dostupn√©: ${avail} / ${item.quantity}</div>
          <p>${escapeHtml(item.description || '')}</p>
          <div style="margin-top:.65rem"><button class="btn" data-id="${
            item.id
          }">Chci koupit</button></div>
          <div class="reservations"><strong>Rezervace:</strong>
            <div>${
              (item.reservations || [])
                .filter((r) => r.status === 'reserved')
                .map(
                  (r) =>
                    `<div>${escapeHtml(
                      r.name,
                    )} <button class=\"btn ghost\" data-cancel=\"${
                      r.id
                    }\">Zru≈°it</button></div>`,
                )
                .join('') || '<div class="small">≈æ√°dn√© rezervace</div>'
            }</div>
          </div>
        `;
          itemsEl.appendChild(div);
        });
        // attach listeners
        document
          .querySelectorAll('.btn[data-id]')
          .forEach((b) => b.addEventListener('click', onReserve));
        document
          .querySelectorAll('.btn[data-cancel]')
          .forEach((b) => b.addEventListener('click', onCancel));
      }

      function escapeHtml(s) {
        return String(s || '').replace(
          /[&<>\"]/g,
          (c) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[c]),
        );
      }

      async function onReserve(e) {
        const id = Number(e.currentTarget.dataset.id);
        const name = prompt('Zadej sv√© jm√©no pro rezervaci:');
        if (!name) return;
        statusEl.textContent = 'Odes√≠l√°m rezervaci‚Ä¶';
        // simple availability check
        const { data: availCheck } = await client
          .from('items')
          .select('id,quantity, reservations(id,qty,status)')
          .eq('id', id)
          .single();
        const reserved = (availCheck.reservations || [])
          .filter((r) => r.status === 'reserved')
          .reduce((s, r) => s + r.qty, 0);
        const available = (availCheck.quantity || 1) - reserved;
        if (available <= 0) {
          alert('Bohu≈æel polo≈æka nen√≠ dostupn√°.');
          statusEl.textContent = '';
          return;
        }
        const { error } = await client
          .from('reservations')
          .insert([
            { item_id: id, name: name.trim(), qty: 1, status: 'reserved' },
          ]);
        if (error) {
          alert('Chyba: ' + error.message);
          statusEl.textContent = '';
          return;
        }
        await loadItems();
      }

      async function onCancel(e) {
        const rid = Number(e.currentTarget.dataset.cancel);
        if (!confirm('Opravdu zru≈°it rezervaci?')) return;
        statusEl.textContent = 'Ru≈°√≠m rezervaci‚Ä¶';
        const { error } = await client
          .from('reservations')
          .update({ status: 'cancelled' })
          .eq('id', rid);
        if (error) {
          alert('Chyba: ' + error.message);
          statusEl.textContent = '';
          return;
        }
        await loadItems();
      }

      seedBtn.addEventListener('click', async () => {
        const seed = [
          {
            title: 'Kniha o designu',
            description: 'Inspirativn√≠ kniha',
            quantity: 1,
          },
          {
            title: 'Kamera',
            description: 'Mal√° digit√°ln√≠ kamera',
            quantity: 1,
          },
          { title: 'Kabely USB-C', description: 'Sada 3ks', quantity: 3 },
          {
            title: 'Sluch√°tka',
            description: 'Bezdr√°tov√° sluch√°tka',
            quantity: 1,
          },
          {
            title: 'Powerbanka 10000mAh',
            description: 'P≈ôenosn√° powerbanka',
            quantity: 2,
          },
          {
            title: 'Bluetooth reproduktor',
            description: 'Mal√Ω hlasit√Ω reproduktor',
            quantity: 1,
          },
          {
            title: 'Stojan na telefon',
            description: 'Nastaviteln√Ω stoln√≠ stojan',
            quantity: 1,
          },
          {
            title: 'Moleskine z√°pisn√≠k',
            description: 'Kapesn√≠ z√°pisn√≠k',
            quantity: 2,
          },
          {
            title: 'Stylus pero',
            description: 'Dotykov√© pero pro tablet',
            quantity: 1,
          },
          { title: 'USB-C hub', description: 'Rozboƒçovaƒç port≈Ø', quantity: 1 },
          {
            title: 'P≈ôenosn√Ω disk 1TB',
            description: 'Extern√≠ HDD/SSD',
            quantity: 1,
          },
          {
            title: 'MicroSD 128GB',
            description: 'Pamƒõ≈•ov√° karta',
            quantity: 2,
          },
          {
            title: 'Triƒçko',
            description: 'Bavlnƒõn√© triƒçko velikost M',
            quantity: 1,
          },
          {
            title: 'Hrnek s potiskem',
            description: 'Keramick√Ω hrnek',
            quantity: 1,
          },
          {
            title: 'Mini n√°≈ôad√≠',
            description: 'Sada mini n√°≈ôad√≠',
            quantity: 1,
          },
          { title: 'LED lampa', description: 'Stoln√≠ LED lampa', quantity: 1 },
          {
            title: 'D√°rkov√Ω poukaz',
            description: 'Poukaz na n√°kup',
            quantity: 1,
          },
          { title: 'Hern√≠ my≈°', description: 'Ergonomick√° my≈°', quantity: 1 },
          {
            title: 'Mechanick√° kl√°vesnice',
            description: 'Tich√© sp√≠naƒçe',
            quantity: 1,
          },
          {
            title: 'Kniha recept≈Ø',
            description: 'Recepty na rychl√° j√≠dla',
            quantity: 1,
          },
        ];
        for (const it of seed) {
          await client.from('items').insert(it);
        }
        loadItems();
      });

      // realtime updates
      try {
        client
          .channel('public:reservations')
          .on(
            'postgres_changes',
            { event: '*', schema: 'public', table: 'reservations' },
            () => loadItems(),
          )
          .subscribe();
      } catch (e) {
        /* ignore if not supported */
      }

      // initial load
      loadItems();
    </script>
  </body>
</html>
